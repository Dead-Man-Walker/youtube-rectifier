<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>YouTube Rectifier</title>
        <meta name="description" content="Rectifier for YouTube's broken playlist shuffle mode">
        <meta name="author" content="Kevin Hambrecht">

        <!-- <link rel="stylesheet" href="css/styles.css?v=1.0"> -->
    </head>


    <body>
        <form id="load-videos-form">
            <fieldset id="load-videos-fieldset" disabled>
                <label for="load-videos-input"> Playlist/Video ID/URL </label>
                <input id="load-videos-input" name="load-videos-input" placeholder="PLVzlUNhyeioT1XMe-U12rfcozOiN6dtyE" type="text" required/>
                <input value="Load" type="submit" />
            </fieldset>
        </form>
        
        <div id="iframe-placeholder"></div>
        <div>
            <button id="controll-videos-shuffle" type="button">Shuffle</button>
            <button id="controll-videos-previous" type="button"><< Previous</button>
            <button id="controll-videos-next" type="button">Next >></button>
        </div>
        <div id="video-list"> </div>
        
        <noscript>
        

var ytPlayer = null;
var ytAPIKey = "AIzaSyCt7PkKtIlJl_uVw-lRpymNR49lD919gFQ";
var videos = [];
var videos_queue = [];
var videos_played = [];



function ready(){
    loadYouTubeAPI();
    
    document.getElementById("controll-videos-shuffle").addEventListener("click", shuffleVideos);
    document.getElementById("controll-videos-previous").addEventListener("click", playPreviousVideo);
    document.getElementById("controll-videos-next").addEventListener("click", playNextVideo);
}



function loadPlaylist(event){
    event.preventDefault()

    let playlist = document.getElementById("load-videos-input").value;
    if(playlist.length === 11){
        // Video id
        console.log(playlist)
        videos = [{
            "id" : playlist,
            "title" : "-",
            "thumbnail" : null
        }];
        videos_queue = [...Array(videos.length).keys()];
        playVideo();
    }else{
        // Playlist id
        fetchPlaylistVideoIds(playlist, (ids)=>{
            videos = ids;
            videos_queue = [...Array(videos.length).keys()];
            playVideo();
        });
    }
}

function fetchPlaylistVideoIds(playlist, finished_cb){
    var ids = [];
    
    var fetchPage = function(page, cb){
        let maxResults = 50;
        let requestUrl = "https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&fields=items/snippet(resourceId/videoId,title,thumbnails/default/url),nextPageToken&playlistId=";
        requestUrl += playlist + "&key=" + ytAPIKey + "&maxResults=" + maxResults;
        if(page){
            requestUrl += "&pageToken=" + page;
        }
        
        let httpRequest = new XMLHttpRequest();
        httpRequest.open("GET", requestUrl, true);
        httpRequest.send(); 
        httpRequest.onload = () => {
            if(httpRequest.status === 200){
                let response = JSON.parse(httpRequest.response);
                cb(response);
                
            }else{
                console.log("ERROR", httpRequest.status, httpRequest.statusText)
            }
        }
    }
    
    var onPageFetched = function(response){
        let container = document.getElementById("video-list");
        
        for(let i=0; i<response.items.length; i++){
            let snippet = response.items[i].snippet;
            let videoId = snippet.resourceId.videoId;
            let title = snippet.title;
            
            let thumbnail;
            try{
                thumbnail = snippet.thumbnails.default.url
            }catch(TypeError){
                thumbnail = null;
            }
            
            ids.push({
                "id" : videoId,
                "title" : title,
                "thumbnail" : thumbnail
            });
            
            let node_p = document.createElement("DIV")
            let node_img = document.createElement("IMG");
            node_img.src = thumbnail;
            let node_title = document.createElement("SPAN");
            node_title.innerHTML = title
            
            node_p.appendChild(node_img);
            node_p.appendChild(node_title);
            
            container.appendChild(node_p);
        }
        if(response.nextPageToken){
            fetchPage(response.nextPageToken, onPageFetched);
        }else{
            finished_cb(ids);
        }
    }
    
    fetchPage(null, onPageFetched);
}


function playVideo(){
    ytPlayer.loadVideoById({
        "videoId" : videos[videos_queue[0]].id,
        "suggestedQuality" : "large"
    });
}

function playNextVideo(){
    videos_played.push(videos_queue.shift());
    playVideo();
}

function playPreviousVideo(){
    videos_queue.unshift(videos_played.pop());
    playVideo();
}

function shuffleVideos(){
    shuffle(videos_queue);
}




function loadYouTubeAPI(){
    let tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    let firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}

function onYouTubeIframeAPIReady(){
    ytPlayer = new YT.Player("video-placeholder", {
        height: "360",
        width: "640",
        playerVars: {
            "autoplay": 0, 
            "controls": 1
        },
        events: {
            "onReady": onYouTubePlayerReady,
            "onStateChange": onYouTubePlayerStateChange,
            "onError" : onYouTubePlayerError
        }
    });
    
    document.getElementById("load-videos-form").addEventListener("submit", loadPlaylist)
    document.getElementById("load-videos-fieldset").disabled = false;
}

function onYouTubePlayerStateChange(event){
    let state = event.data
    
    if(state === YT.PlayerState.CUED){
    }
}

function onYouTubePlayerReady(event){
    console.log("onYouTubePlayerReady")
}

function onYouTubePlayerError(event){
    //alert("YouTube Player Error " + event.data)
    console.log("YouTube Player Error " + event.data, event)
}


/**
 * Shuffles array in place. ES6 version
 * @param {Array} a items An array containing the items.
 */
function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

document.addEventListener("DOMContentLoaded", ready, false);
        </noscript>
        
        <script src="index.js"></script>
    </body>
</html>
